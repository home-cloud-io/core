syntax = "proto3";

package platform.daemon.v1;

option go_package = "github.com/home-cloud-io/core/api/platform/daemon/v1";

service DaemonStreamService {
  rpc Communicate(stream DaemonMessage) returns (stream ServerMessage) {}
}

message DaemonMessage {
  oneof message {
    Heartbeat heartbeat = 1;
    ShutdownAlert shutdown_alert = 2;
  }
}

message ServerMessage {
  oneof message {
    Heartbeat heartbeat = 1;
    ShutdownCommand shutdown = 2;
    RestartCommand restart = 3;
  }
}

// Bidirectional

message Heartbeat { }

// Daemon -> Server

// ShutdownAlert notifies the Server that the host is about to shutdown
message ShutdownAlert { }

message UpgradeAvailableAlert {
  string description = 1;
}

// Server -> Daemon

// ShutdownCommand tells the daemon to shutdown the host: `shutdown now`
message ShutdownCommand { }

// RestartCommand tells the daemon to restart the host: `reboot now`
message RestartCommand { }

// CheckForUpdatesCommand tells the daemon to check for updates to the host:
// - nixos-rebuild build
// - nvd diff /run/current-system ./result
// - publish the results of this to the Server using the UpgradeAvailableAlert
// - rm ./result
message CheckForUpdatesCommand { }
