syntax = "proto3";

package platform.server.v1;

option go_package = "github.com/home-cloud-io/core/api/platform/server/v1";

import "platform/daemon/v1/system.proto";

service WebService {
  // Subscribe to the server for events
  rpc Subscribe(SubscribeRequest) returns (stream ServerEvent) {}

  // APPS

  // Install a Home Cloud application
  rpc InstallApp(InstallAppRequest) returns (InstallAppResponse) {}
  // Update a Home Cloud application
  rpc UpdateApp(UpdateAppRequest) returns (UpdateAppResponse) {}
  // Delete a Home Cloud application
  rpc DeleteApp(DeleteAppRequest) returns (DeleteAppResponse) {}
  // Check the current health of all installed Home Cloud applications
  rpc AppsHealthCheck(AppsHealthCheckRequest) returns (AppsHealthCheckResponse) {}
  // Get all apps available in the store
  rpc GetAppsInStore(GetAppsInStoreRequest) returns (GetAppsInStoreResponse) {}
  // Get all installed app storage volumes
  rpc GetAppStorage(GetAppStorageRequest) returns (GetAppStorageResponse) {}

  // SYSTEM

  // Shutdown the host machine running Home Cloud
  rpc ShutdownHost(ShutdownHostRequest) returns (ShutdownHostResponse) {}
  // Restart the host machine running Home Cloud
  rpc RestartHost(RestartHostRequest) returns (RestartHostResponse) {}
  // Get the current host machine stats (cpu, memory, drives)
  rpc GetSystemStats(GetSystemStatsRequest) returns (GetSystemStatsResponse) {}
  // GetComponentVersions returns the versions of all system components (daemon, server, etc.)
  rpc GetComponentVersions(GetComponentVersionsRequest) returns (GetComponentVersionsResponse) {}
  // GetSystemLogs returns the past X seconds of system logs (daemon, server, fuse, etc.)
  rpc GetSystemLogs(GetSystemLogsRequest) returns (GetSystemLogsResponse) {}

  // SETTINGS

  // Get the device settings
  rpc GetDeviceSettings(GetDeviceSettingsRequest) returns (GetDeviceSettingsResponse) {}
  // Set the device settings
  rpc SetDeviceSettings(SetDeviceSettingsRequest) returns (SetDeviceSettingsResponse) {}

  // TUNNELLING

  // Enables the remote access feature
  rpc EnableSecureTunnelling(EnableSecureTunnellingRequest) returns (EnableSecureTunnellingResponse) {}
  // Disables the remote access feature
  rpc DisableSecureTunnelling(DisableSecureTunnellingRequest) returns (DisableSecureTunnellingResponse) {}
  // Register the server with the given Locator service
  rpc RegisterToLocator(RegisterToLocatorRequest) returns (RegisterToLocatorResponse) {}
  // Deregister the server from the given Locator service
  rpc DeregisterFromLocator(DeregisterFromLocatorRequest) returns (DeregisterFromLocatorResponse) {}
  // RegisterPeer adds a peer to remote access
  rpc RegisterPeer(RegisterPeerRequest) returns (RegisterPeerResponse) {}
  // DeregisterPeer removes a peer from remote access
  rpc DeregisterPeer(DeregisterPeerRequest) returns (DeregisterPeerResponse) {}
}

message ShutdownHostRequest {}
message ShutdownHostResponse {}

message RestartHostRequest {}
message RestartHostResponse {}

message InstallAppRequest {
  string chart = 1;
  string repo = 2;
  string release = 3;
  string values = 4;
  string version = 5;
}
message InstallAppResponse {}

message UpdateAppRequest {
  string chart = 1;
  string repo = 2;
  string release = 3;
  string values = 4;
  string version = 5;
}
message UpdateAppResponse {}

message DeleteAppRequest {
  string release = 1;
}
message DeleteAppResponse {}

message ImageVersion {
  string image = 1;
  string current = 2;
  string latest = 3;
  string name = 4;
}

message AppsHealthCheckRequest {}
message AppsHealthCheckResponse {
  repeated AppHealth checks = 1;
}

message AppHealth {
  string name = 1;
  AppStatus status = 2;
  AppDisplay display = 3;
}

enum AppStatus {
  APP_STATUS_UNSPECIFIED = 0;
  APP_STATUS_HEALTHY = 1;
  APP_STATUS_UNHEALTHY = 2;
}

message AppDisplay {
  string name = 1;
  string icon_url = 2;
  string description = 3;
}

message GetSystemStatsRequest {}
message GetSystemStatsResponse {
  platform.daemon.v1.SystemStats stats = 1;
}

message GetAppsInStoreRequest {}
message GetAppsInStoreResponse {
  repeated App apps = 1;
}

message GetDeviceSettingsRequest {}
message GetDeviceSettingsResponse {
  DeviceSettings settings = 1;
}

message SetDeviceSettingsRequest {
  DeviceSettings settings = 1;
}
message SetDeviceSettingsResponse {}

message GetAppStorageRequest {}
message GetAppStorageResponse {
  repeated AppStorage apps = 1;
}
message AppStorage {
  string app_name = 1;
  repeated string volumes = 2;
}

message EnableSecureTunnellingRequest {}
message EnableSecureTunnellingResponse {}

message DisableSecureTunnellingRequest {}
message DisableSecureTunnellingResponse {}

message RegisterToLocatorRequest {
  string locator_address = 1;
  string wireguard_interface = 2;
  // TODO: eventually this is where the access key will be included that the user receives after purchasing the locator subscription
}
message RegisterToLocatorResponse {}

message DeregisterFromLocatorRequest {
  string locator_address = 1;
  string wireguard_interface = 2;
}
message DeregisterFromLocatorResponse {}

message GetComponentVersionsRequest {
}

message GetComponentVersionsResponse {
  repeated platform.daemon.v1.ComponentVersion platform = 1;
  repeated platform.daemon.v1.ComponentVersion system = 2;
}

message GetSystemLogsRequest {
  // A relative time in seconds before the current time from which to show logs.
  uint32 since_seconds = 1;
}

message GetSystemLogsResponse {
  repeated platform.daemon.v1.Log logs = 1;
  repeated string sources = 2;
  repeated string namespaces = 3;
  repeated string domains = 4;
}

//////////////////////////////////////////////////////////////////////////
// MODELS
//////////////////////////////////////////////////////////////////////////

message Apps {
  repeated App apps = 1;
}

// Model used for the store and installed apps
// NOTE: that this must match the shape of the `entries` from a Helm repo
// index: e.g. https://apps.home-cloud.io/index.yaml
message App {
  string name = 1;
  string version = 2;
  string app_version = 3;
  string description = 4;
  string icon = 5;
  string created = 6;
  string digest = 7;
  string type = 8;
  repeated string urls = 9;
  repeated AppDependency dependencies = 10;
  string home = 11;
  repeated string sources = 12;
  map<string, string> annotations = 13;
  // readme is not from the index but is added by the server from
  // the README.md of the chart.
  string readme = 14;
  // installed denotes whether or not the app is installed on the server
  bool installed = 15;
}

message AppDependency {
  string name = 1;
  string version = 2;
  string repository = 3;
}

message AppRunningStatus {
  string name = 1;
  string version = 2;
  AppStatus status = 3;
}

message Entries {
  repeated App apps = 1;
}

message SystemVersion {
  string version = 1;
  IstioVersion istio = 2;
  GatewayAPIVersion gateway_api = 3;
  ServerVersion server = 4;
  DaemonVersion daemon = 5;
}

message IstioVersion {
  string repo = 1;
  string version = 2;
}

message GatewayAPIVersion {
  string url = 1;
  string version = 2;
}

message ServerVersion {
  string image = 1;
  string tag = 2;
}

message DaemonVersion {
  string image = 1;
  string tag = 2;
}

// Model to cache the apps available in the store: https://apps.home-cloud.io/index.yaml
message AppStoreEntries {
  string api_version = 1;
  string generated = 2;
  string raw_chart_url = 3;
  map<string, Apps> entries = 4;
}

// User settings for the device
message DeviceSettings {
  bool auto_update_apps = 1;
  bool auto_update_os = 2;
  SecureTunnelingSettings secure_tunneling_settings = 3;
  string hostname = 4;
  string auto_update_apps_schedule = 5;
  repeated AppStore app_stores = 6;
}

message SecureTunnelingSettings {
  bool enabled = 1;
  repeated WireguardInterface wireguard_interfaces = 2;
}

message WireguardInterface {
  string id = 1;
  string name = 2;
  int32 port = 3;
  string public_key = 4;
  string stun_server = 5;
  repeated string locator_servers = 6;
}

message AppStore {
  string url = 1;
  string raw_chart_url = 2;
}

// Subscription events

message SubscribeRequest {}

message ServerEvent {
  oneof event {
    HeartbeatEvent heartbeat = 1;
    ErrorEvent error = 2;
    AppInstalledEvent app_installed = 3;
  }
}

message HeartbeatEvent {}

message ErrorEvent {
  string error = 1;
}

message AppInstalledEvent {
  string name = 1;
}

message RegisterPeerRequest {}
message RegisterPeerResponse{
  string id = 1;

  // client config
  string private_key = 2;
  string public_key = 3;
  repeated string addresses = 4;
  repeated string dns_servers = 5;

  // server config
  string server_public_key = 6;
  string server_id = 7;
  repeated string locator_servers = 8;
}

message DeregisterPeerRequest {
  string id = 1;
}
message DeregisterPeerResponse{}
